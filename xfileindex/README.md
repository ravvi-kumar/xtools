# xfileindex

Index file attachments content from `file` and `file[]` columns into `text` columns.

## Description

This script indexes content from files stored in Xata, into text columns in a target table so that the content can be used with Xata's advanced features such as full-text search and askAI.

Currently the supported media types are: text/plain, text/csv, application/pdf.

The content is chunked to fit into Xata's `text` column type (200kb). PDF files are indexed as one record per page and further split into chunks if necessary.

## Usage

Basic example:

```
python3 xfileindex.py --db https://{workspace}.{region}.xata.sh/db/{db} --table mytable --columns myfile,mymultiplefiles
```

Expects the Xata API key is set in env variable `XATA_API_KEY`.

The default behavior is to generated deterministic ids for the indexed records so that, in case the script is triggered multiple times on the same table, results are overwritten rather than creating duplicates.

In case the file content in an existing record & column is modified, the number of resulting chunks might differ so there can be excess leftover records from previous runs of the script.

## Parameters

Required parameters:
- `--db`: The database URL, retrieved from your Database Settings -> Database endpoint.
- `--table`: The table we are reading files from.
- `--columns`: The columns we are reading files from. If more than one, comma separated.

Optional parameters:
- `--branch`: The database branch to use. Default is `main`.
- `--dest`: Target table name. By default, it is created by appending "Index" to the source table name.
- `--encoding`: Encoding to use for reading text files. Default is `ascii`.
- `--id`: Create deterministic ids or use autogenerated ids. Records with `deterministic` ids are written with `upsert` operations while `random` ids are written with `insert` operations. Default is `deterministic`, so records (chunks) from the same files are overwritten in the target table.
- `--maxchunk`: Maximum text chunk size. Default is `200000` which is the maximum text column size supported in Xata.
- `--mode`: Select write mode between `atomic` or `transaction`. The default mode is [transaction](https://xata.io/docs/sdk/transaction) which is faster and more efficient as it writes multiple records with each request. The `atomic` mode writes one record per request and can be used for troubleshooting purposes such as inspecting the response code and message for certain chunks.
- `--tsize`: Relevant only when write mode is `transaction`, specifies how many chunks (records) will be written or updated with every request. The maximum allowed number of operations per transaction is `1000`.
-- `--psize`: The number of records per page to fetch while scrolling. Default is `200`, which is also the maximum.

## Dependencies

Dependencies can be installed with:

```
pip3 install -r requirements.txt
```

Your system might use Python 3 by default so the commands `python3` and `pip3` are interchangeable to `python` and `pip`.

## Using with other file types

File types that are not supported by this script are skipped. If you would like to ingest content from other documents, such as docx or xls, we recommend converting to a simplified format (txt,csv) before uploading to Xata, for this script to work on them.


# localfileindex

An alternative version of the script that indexes local files (from disk, instead of file attachments) to Xata.
Provides only the transactions and random id indexing approach.
It extrapolates the file type from the file extension, supporting `.pdf`,`.txt`,`.csv`.

Usage:

```
python localfileindex.py --db https://{workspace}.{region}.xata.sh/db/{db} --file ~/path/to/myfile.txt --dest mytable
```

localfileindex Parameters:

- `--db`: The database URL, retrieved from your Database Settings -> Database endpoint.
- `--file`: The local file (or full path to the file) to index to Xata.
- `--encoding`: Encoding to use for reading text files. Default is `UTF-8` for compatibility with default unix-based OS file encoding. Set UTF-16 for Windows files.
- `--maxchunk`: Maximum text chunk size. Default is `200000` which is the maximum text column size supported in Xata.
- `--tsize`: Specifies how many chunks (records) will be emitted with every write request. The maximum allowed number of operations per transaction is `1000`.